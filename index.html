<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>云景天气 | CloudView Weather</title>
    
    <!-- PWA Meta Tags -->
    <meta name="description" content="精美的天气预报应用">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="云景天气">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Noto Sans SC"', 'sans-serif'],
                    },
                    colors: {
                        glass: "rgba(255, 255, 255, 0.2)",
                        glassBorder: "rgba(255, 255, 255, 0.3)",
                        glassText: "rgba(255, 255, 255, 0.9)",
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            transition: background 0.8s ease;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .glass-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .weather-icon-anim {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .hide-scroll::-webkit-scrollbar {
            display: none;
        }
        .hide-scroll {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
            opacity: 0;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* 搜索提示框样式 */
        #suggestions {
            animation: slideDown 0.2s ease-out;
        }
        
        @keyframes slideDown {
            from { 
                opacity: 0; 
                transform: translateY(-10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        #suggestions::-webkit-scrollbar {
            width: 6px;
        }
        
        #suggestions::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }
        
        #suggestions::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 3px;
        }
        
        #suggestions::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="flex items-center justify-center p-4">

    <div class="glass-panel w-full max-w-4xl rounded-3xl overflow-hidden shadow-2xl flex flex-col md:flex-row min-h-[600px] relative">
        
        <div class="w-full md:w-2/5 p-8 flex flex-col justify-between relative z-10 bg-black/10 md:bg-transparent">
            
            <div class="relative">
                <input type="text" id="city-input" placeholder="输入城市 (如: 北京)" 
                    class="glass-input w-full rounded-full py-3 pl-4 pr-12 outline-none focus:bg-white/20 transition-all"
                    autocomplete="off">
                <button onclick="handleSearch()" class="absolute right-2 top-1/2 -translate-y-1/2 p-2 hover:bg-white/20 rounded-full transition-colors">
                    <i data-lucide="search" class="w-5 h-5 text-white"></i>
                </button>
                <!-- 搜索提示下拉框 -->
                <div id="suggestions" class="hidden absolute top-full left-0 right-0 mt-2 glass-panel rounded-2xl overflow-hidden max-h-64 overflow-y-auto z-50"></div>
            </div>

            <div id="loading-msg" class="hidden mt-4 text-center text-sm animate-pulse flex items-center justify-center gap-2">
                <span class="inline-block w-2 h-2 bg-white rounded-full animate-bounce"></span>
                正在获取实时数据...
            </div>
            <div id="error-msg" class="hidden mt-4 text-center text-sm text-red-200 bg-red-500/20 py-2 rounded-lg border border-red-500/30"></div>

            <div id="main-weather" class="flex flex-col items-center mt-8 md:mt-0 fade-in hidden">
                <div id="weather-icon-container" class="weather-icon-anim mb-4">
                </div>
                <h1 id="temp-display" class="text-7xl font-bold tracking-tighter">--°</h1>
                <p id="weather-desc" class="text-xl mt-2 font-medium opacity-90">--</p>
                <div class="h-px w-16 bg-white/30 my-6"></div>
                <div class="text-center">
                    <h2 id="city-display" class="text-2xl font-bold">--</h2>
                    <p id="date-display" class="text-sm opacity-75 mt-1">--</p>
                </div>
            </div>
        </div>

        <div class="w-full md:w-3/5 p-8 bg-black/20 flex flex-col justify-between">
            
            <div class="mb-8 fade-in" style="animation-delay: 0.1s;">
                <h3 class="uppercase text-sm font-bold tracking-widest mb-4 opacity-70">今日详情</h3>
                <div class="grid grid-cols-2 gap-4">
                    <div class="glass-panel p-4 rounded-xl flex items-center space-x-3 hover:bg-white/10 transition-colors">
                        <i data-lucide="droplets" class="w-6 h-6 text-blue-300"></i>
                        <div>
                            <p class="text-xs opacity-60">湿度</p>
                            <p id="humidity-display" class="text-lg font-bold">--%</p>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex items-center space-x-3 hover:bg-white/10 transition-colors">
                        <i data-lucide="wind" class="w-6 h-6 text-gray-300"></i>
                        <div>
                            <p class="text-xs opacity-60">风速</p>
                            <p id="wind-display" class="text-lg font-bold">-- km/h</p>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex items-center space-x-3 hover:bg-white/10 transition-colors">
                        <i data-lucide="thermometer" class="w-6 h-6 text-red-300"></i>
                        <div>
                            <p class="text-xs opacity-60">体感</p>
                            <p id="feels-like-display" class="text-lg font-bold">--°</p>
                        </div>
                    </div>
                    <div class="glass-panel p-4 rounded-xl flex items-center space-x-3 hover:bg-white/10 transition-colors">
                        <i data-lucide="eye" class="w-6 h-6 text-purple-300"></i>
                        <div>
                            <p class="text-xs opacity-60">能见度</p>
                            <p id="visibility-display" class="text-lg font-bold">-- km</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="fade-in" style="animation-delay: 0.2s;">
                <h3 class="uppercase text-sm font-bold tracking-widest mb-4 opacity-70">未来预报</h3>
                <div id="forecast-container" class="flex space-x-4 overflow-x-auto hide-scroll pb-2">
                    <div class="text-sm opacity-50 p-2">请输入城市获取预报</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 等待Lucide库加载完成
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        } else {
            window.addEventListener('load', () => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            });
        }

        // 中国城市拼音映射表（按人口和重要性排序）
        const chineseCities = [
            // 直辖市
            { pinyin: 'beijing', name: '北京', aliases: ['bei', 'bj'] },
            { pinyin: 'shanghai', name: '上海', aliases: ['shang', 'sh'] },
            { pinyin: 'guangzhou', name: '广州', aliases: ['guang', 'gz'] },
            { pinyin: 'shenzhen', name: '深圳', aliases: ['shen', 'sz'] },
            { pinyin: 'tianjin', name: '天津', aliases: ['tian', 'tj'] },
            { pinyin: 'chongqing', name: '重庆', aliases: ['chong', 'cq'] },
            
            // 省会及重要城市
            { pinyin: 'chengdu', name: '成都', aliases: ['cheng', 'cd'] },
            { pinyin: 'hangzhou', name: '杭州', aliases: ['hang', 'hz'] },
            { pinyin: 'wuhan', name: '武汉', aliases: ['wu', 'wh'] },
            { pinyin: 'xian', name: '西安', aliases: ['xi', 'xa'] },
            { pinyin: 'nanjing', name: '南京', aliases: ['nan', 'nj'] },
            { pinyin: 'suzhou', name: '苏州', aliases: ['su', 'suz'] },
            { pinyin: 'qingdao', name: '青岛', aliases: ['qing', 'qd'] },
            { pinyin: 'dalian', name: '大连', aliases: ['da', 'dl'] },
            { pinyin: 'ningbo', name: '宁波', aliases: ['ning', 'nb'] },
            { pinyin: 'zhengzhou', name: '郑州', aliases: ['zheng', 'zz'] },
            { pinyin: 'changsha', name: '长沙', aliases: ['chang', 'cs'] },
            { pinyin: 'shenyang', name: '沈阳', aliases: ['sheny', 'sy'] },
            { pinyin: 'harbin', name: '哈尔滨', aliases: ['ha', 'heb'] },
            { pinyin: 'jinan', name: '济南', aliases: ['ji', 'jn'] },
            { pinyin: 'kunming', name: '昆明', aliases: ['kun', 'km'] },
            { pinyin: 'fuzhou', name: '福州', aliases: ['fu', 'fz'] },
            { pinyin: 'xiamen', name: '厦门', aliases: ['xia', 'xm'] },
            { pinyin: 'hefei', name: '合肥', aliases: ['he', 'hf'] },
            { pinyin: 'nanchang', name: '南昌', aliases: ['nanc', 'nc'] },
            { pinyin: 'guiyang', name: '贵阳', aliases: ['gui', 'gy'] },
            { pinyin: 'taiyuan', name: '太原', aliases: ['tai', 'ty'] },
            { pinyin: 'shijiazhuang', name: '石家庄', aliases: ['shi', 'sjz'] },
            { pinyin: 'nanning', name: '南宁', aliases: ['nann', 'nn'] },
            { pinyin: 'urumqi', name: '乌鲁木齐', aliases: ['wu', 'wlmq'] },
            { pinyin: 'lanzhou', name: '兰州', aliases: ['lan', 'lz'] },
            { pinyin: 'yinchuan', name: '银川', aliases: ['yin', 'yc'] },
            { pinyin: 'xining', name: '西宁', aliases: ['xin', 'xn'] },
            { pinyin: 'hohhot', name: '呼和浩特', aliases: ['hu', 'hhht'] },
            { pinyin: 'lhasa', name: '拉萨', aliases: ['la', 'ls'] },
            { pinyin: 'haikou', name: '海口', aliases: ['hai', 'hk'] },
            
            // 其他重要城市
            { pinyin: 'dongguan', name: '东莞', aliases: ['dong', 'dg'] },
            { pinyin: 'foshan', name: '佛山', aliases: ['fo', 'fs'] },
            { pinyin: 'wuxi', name: '无锡', aliases: ['wux'] },
            { pinyin: 'changzhou', name: '常州', aliases: ['changz', 'cz'] },
            { pinyin: 'wenzhou', name: '温州', aliases: ['wen', 'wz'] },
            { pinyin: 'nantong', name: '南通', aliases: ['nant', 'nt'] },
            { pinyin: 'yangzhou', name: '扬州', aliases: ['yang', 'yz'] },
            { pinyin: 'zhuhai', name: '珠海', aliases: ['zhu', 'zh'] },
            { pinyin: 'zhongshan', name: '中山', aliases: ['zhong', 'zs'] },
            { pinyin: 'huizhou', name: '惠州', aliases: ['hui', 'huz'] },
            { pinyin: 'jiangmen', name: '江门', aliases: ['jiang', 'jm'] },
            { pinyin: 'shaoxing', name: '绍兴', aliases: ['shao', 'sx'] },
            { pinyin: 'jinhua', name: '金华', aliases: ['jin', 'jh'] },
            { pinyin: 'taizhou', name: '台州', aliases: ['taiz', 'tz'] },
            { pinyin: 'yantai', name: '烟台', aliases: ['yan', 'yt'] },
            { pinyin: 'weifang', name: '潍坊', aliases: ['wei', 'wf'] },
            { pinyin: 'zibo', name: '淄博', aliases: ['zi', 'zb'] },
            { pinyin: 'baoding', name: '保定', aliases: ['bao', 'bd'] },
            { pinyin: 'tangshan', name: '唐山', aliases: ['tang', 'ts'] },
            { pinyin: 'anshan', name: '鞍山', aliases: ['an', 'as'] },
            { pinyin: 'luoyang', name: '洛阳', aliases: ['luo', 'ly'] },
            { pinyin: 'changchun', name: '长春', aliases: ['changc', 'cc'] },
            
            // 以"上"开头的城市
            { pinyin: 'shangrao', name: '上饶', aliases: ['shangr', 'sr'] },
            { pinyin: 'shangqiu', name: '商丘', aliases: ['shangq', 'sq'] },
            { pinyin: 'shantou', name: '汕头', aliases: ['shant', 'st'] },
            { pinyin: 'shanwei', name: '汕尾', aliases: ['shanw', 'sw'] },
            
            // 港澳台
            { pinyin: 'hongkong', name: '香港', aliases: ['hong', 'hk', 'xianggang'] },
            { pinyin: 'macau', name: '澳门', aliases: ['ao', 'aomen'] },
            { pinyin: 'taipei', name: '台北', aliases: ['taib', 'tb'] },
            { pinyin: 'kaohsiung', name: '高雄', aliases: ['gao', 'kx'] },
        ];

        const weatherTypes = {
            sunny: { codes: [0, 1], desc: "晴朗", icon: "sun", color: "text-yellow-300", bg: "linear-gradient(135deg, #f6d365 0%, #fda085 100%)" },
            cloudy: { codes: [2, 3, 45, 48], desc: "多云/阴", icon: "cloud-sun", color: "text-gray-200", bg: "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)" },
            drizzle: { codes: [51, 53, 55, 56, 57], desc: "小雨", icon: "cloud-drizzle", color: "text-blue-300", bg: "linear-gradient(135deg, #667eea 0%, #764ba2 100%)" },
            rain: { codes: [61, 63, 65, 66, 67, 80, 81, 82], desc: "下雨", icon: "cloud-rain", color: "text-blue-400", bg: "linear-gradient(135deg, #2b5876 0%, #4e4376 100%)" },
            snow: { codes: [71, 73, 75, 77, 85, 86], desc: "下雪", icon: "snowflake", color: "text-cyan-200", bg: "linear-gradient(135deg, #83a4d4 0%, #b6fbff 100%)" },
            thunder: { codes: [95, 96, 99], desc: "雷雨", icon: "cloud-lightning", color: "text-purple-400", bg: "linear-gradient(135deg, #141E30 0%, #243B55 100%)" },
        };

        const els = {
            input: document.getElementById('city-input'),
            suggestions: document.getElementById('suggestions'),
            loading: document.getElementById('loading-msg'),
            error: document.getElementById('error-msg'),
            mainWeather: document.getElementById('main-weather'),
            temp: document.getElementById('temp-display'),
            desc: document.getElementById('weather-desc'),
            city: document.getElementById('city-display'),
            date: document.getElementById('date-display'),
            iconContainer: document.getElementById('weather-icon-container'),
            humidity: document.getElementById('humidity-display'),
            wind: document.getElementById('wind-display'),
            feelsLike: document.getElementById('feels-like-display'),
            visibility: document.getElementById('visibility-display'),
            forecast: document.getElementById('forecast-container'),
            body: document.body
        };

        // 防抖函数
        let searchTimeout;
        
        // 统一的搜索触发函数
        function triggerSearch(query) {
            clearTimeout(searchTimeout);
            
            if (!query || query.length === 0) {
                els.suggestions.classList.add('hidden');
                return;
            }
            
            // 防抖：等待用户停止输入500ms后再搜索（增加延迟以适应输入法）
            searchTimeout = setTimeout(() => {
                fetchCitySuggestions(query);
            }, 500);
        }
        
        // 输入事件监听 - 搜索提示（简化版本，兼容所有输入方式）
        els.input.addEventListener('input', function (e) {
            const query = e.target.value.trim();
            triggerSearch(query);
        });

        // 回车键搜索
        els.input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') {
                els.suggestions.classList.add('hidden');
                handleSearch();
            }
        });

        // 点击外部关闭提示框
        document.addEventListener('click', function(e) {
            if (!els.input.contains(e.target) && !els.suggestions.contains(e.target)) {
                els.suggestions.classList.add('hidden');
            }
        });

        // 获取城市搜索建议
        async function fetchCitySuggestions(query) {
            try {
                const lowerQuery = query.toLowerCase();
                
                // 1. 先从本地拼音库匹配（优先中国城市）
                const localMatches = chineseCities.filter(city => {
                    // 检查拼音、别名、中文名是否匹配
                    return city.pinyin.startsWith(lowerQuery) || 
                           city.aliases.some(alias => alias.startsWith(lowerQuery)) ||
                           city.name.includes(query);
                }).slice(0, 5); // 最多5个
                
                // 2. 如果本地匹配到结果，直接显示
                if (localMatches.length > 0) {
                    displayLocalSuggestions(localMatches);
                    return;
                }
                
                // 3. 如果没有本地匹配，调用API搜索
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=zh&format=json`;
                const response = await fetch(geoUrl);
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    displaySuggestions(data.results);
                } else {
                    els.suggestions.classList.add('hidden');
                }
            } catch (err) {
                console.error('获取城市建议失败:', err);
                els.suggestions.classList.add('hidden');
            }
        }

        // 显示本地拼音匹配的建议
        function displayLocalSuggestions(cities) {
            els.suggestions.innerHTML = '';
            
            cities.forEach(city => {
                const item = document.createElement('div');
                item.className = 'px-4 py-3 hover:bg-white/20 cursor-pointer transition-colors flex flex-col gap-1';
                
                // 首字母大写的拼音
                const capitalizedPinyin = city.pinyin.charAt(0).toUpperCase() + city.pinyin.slice(1);
                
                item.innerHTML = `
                    <span class="text-white font-medium">${capitalizedPinyin} ${city.name}</span>
                    <span class="text-white/60 text-xs">中国</span>
                `;
                
                // 点击建议项
                item.addEventListener('click', () => {
                    els.input.value = city.name;
                    els.suggestions.classList.add('hidden');
                    fetchWeatherData(city.name);
                });
                
                els.suggestions.appendChild(item);
            });
            
            els.suggestions.classList.remove('hidden');
        }

        // 显示API搜索建议
        function displaySuggestions(cities) {
            els.suggestions.innerHTML = '';
            
            cities.forEach(city => {
                const item = document.createElement('div');
                item.className = 'px-4 py-3 hover:bg-white/20 cursor-pointer transition-colors flex flex-col gap-1';
                
                // 获取城市的多语言名称
                const latinName = city.name || ''; // 拉丁字母名称（英文/拼音）
                const nativeName = city.name_native || ''; // 当地语言名称
                const countryCode = city.country_code || '';
                
                // 构建智能显示名称
                let displayNames = [];
                
                // 1. 添加拉丁字母名称（英文优先）
                if (latinName) {
                    displayNames.push(latinName);
                }
                
                // 2. 添加中文翻译（如果是中国城市）
                let chineseName = '';
                if (countryCode === 'CN' || countryCode === 'TW' || countryCode === 'HK' || countryCode === 'MO') {
                    // 从本地城市库查找中文名
                    const localCity = chineseCities.find(c => 
                        c.pinyin.toLowerCase() === latinName.toLowerCase() || 
                        c.name === latinName
                    );
                    if (localCity) {
                        chineseName = localCity.name;
                        // 如果拉丁名就是中文，不重复添加
                        if (chineseName !== latinName) {
                            displayNames.push(chineseName);
                        }
                    } else if (nativeName && !isLatin(nativeName) && nativeName !== latinName) {
                        // 使用原生名称作为中文名
                        chineseName = nativeName;
                        displayNames.push(nativeName);
                    }
                }
                
                // 3. 添加当地语言名称（如果不同于已有的）
                if (nativeName && 
                    nativeName !== latinName && 
                    nativeName !== chineseName && 
                    !isLatin(nativeName)) {
                    displayNames.push(nativeName);
                }
                
                // 构建显示文本
                const nameDisplay = displayNames.join(' ');
                
                // 地区信息（可选）
                let region = city.admin1 || '';
                if (region && (region.includes('台湾') || region.includes('Taiwan'))) {
                    region = '';
                } else if (region && region !== latinName) {
                    region = `, ${region}`;
                } else {
                    region = '';
                }
                
                const country = city.country || '';
                
                item.innerHTML = `
                    <span class="text-white font-medium">${nameDisplay}${region}</span>
                    <span class="text-white/60 text-xs">${country}</span>
                `;
                
                // 点击建议项 - 使用中文名（如果有）或拉丁名
                item.addEventListener('click', () => {
                    els.input.value = chineseName || latinName;
                    els.suggestions.classList.add('hidden');
                    fetchWeatherData(chineseName || latinName);
                });
                
                els.suggestions.appendChild(item);
            });
            
            els.suggestions.classList.remove('hidden');
        }
        
        // 检查字符串是否只包含拉丁字母、数字和常见标点
        function isLatin(str) {
            return /^[A-Za-z0-9\s\-',\.]+$/.test(str);
        }

        window.onload = () => {
            fetchWeatherData("北京");
        };

        function getWeatherType(code) {
            for (const key in weatherTypes) {
                if (weatherTypes[key].codes.includes(code)) {
                    return weatherTypes[key];
                }
            }
            return weatherTypes.cloudy;
        }

        async function handleSearch() {
            const city = els.input.value.trim();
            if (!city) return;
            await fetchWeatherData(city);
        }

        async function fetchWeatherData(city) {
            els.loading.classList.remove('hidden');
            els.error.classList.add('hidden');
            els.mainWeather.classList.add('hidden');

            try {
                const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh&format=json`;
                const geoRes = await fetch(geoUrl);
                const geoData = await geoRes.json();

                if (!geoData.results || geoData.results.length === 0) {
                    throw new Error("未找到该城市，请检查拼写。");
                }

                const { latitude, longitude, name, admin1, country } = geoData.results[0];
                // 只显示城市名，避免显示错误的省份信息
                const displayName = name;

                const weatherUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,weather_code,wind_speed_10m,wind_direction_10m&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=auto`;
                
                const weatherRes = await fetch(weatherUrl);
                const weatherData = await weatherRes.json();

                updateWeatherUI(weatherData, displayName);

            } catch (err) {
                console.error(err);
                els.error.textContent = err.message || "获取天气数据失败，请稍后重试。";
                els.error.classList.remove('hidden');
            } finally {
                els.loading.classList.add('hidden');
            }
        }

        function updateWeatherUI(data, cityName) {
            const current = data.current;
            const daily = data.daily;
            const weatherType = getWeatherType(current.weather_code);

            els.body.style.background = weatherType.bg;

            els.city.textContent = cityName;
            els.temp.textContent = `${Math.round(current.temperature_2m)}°`;
            els.desc.textContent = weatherType.desc;
            
            const now = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            els.date.textContent = now.toLocaleDateString('zh-CN', options);

            els.iconContainer.innerHTML = `<i data-lucide="${weatherType.icon}" class="w-24 h-24 ${weatherType.color}"></i>`;

            els.humidity.textContent = `${current.relative_humidity_2m}%`;
            els.wind.textContent = `${current.wind_speed_10m} km/h`;
            els.feelsLike.textContent = `${Math.round(current.apparent_temperature)}°`;
            
            let visibility = "良好";
            if(current.weather_code > 45) visibility = "一般";
            if(current.weather_code === 45 || current.weather_code === 48) visibility = "较低";
            els.visibility.textContent = visibility;

            els.forecast.innerHTML = '';
            
            const forecastDays = daily.time.slice(1, 6);
            
            forecastDays.forEach((timeStr, index) => {
                const realIndex = index + 1;
                const code = daily.weather_code[realIndex];
                const max = Math.round(daily.temperature_2m_max[realIndex]);
                const min = Math.round(daily.temperature_2m_min[realIndex]);
                const dayType = getWeatherType(code);

                const dateObj = new Date(timeStr);
                const dayName = dateObj.toLocaleDateString('zh-CN', { weekday: 'short' });
                const dateDisplay = dateObj.toLocaleDateString('zh-CN', { month: 'numeric', day: 'numeric' });
                
                const card = document.createElement('div');
                card.className = "glass-panel min-w-[100px] p-3 rounded-xl flex flex-col items-center justify-center space-y-2 hover:bg-white/20 transition-all cursor-default";
                card.innerHTML = `
                    <p class="text-sm font-medium">${dayName}</p>
                    <p class="text-xs opacity-60">${dateDisplay}</p>
                    <i data-lucide="${dayType.icon}" class="w-8 h-8 my-1 ${dayType.color}"></i>
                    <p class="text-sm font-bold">${max}° <span class="text-xs opacity-60 font-normal">/ ${min}°</span></p>
                `;
                els.forecast.appendChild(card);
            });

            els.mainWeather.classList.remove('hidden');
            
            lucide.createIcons();

            els.mainWeather.classList.remove('fade-in');
            void els.mainWeather.offsetWidth;
            els.mainWeather.classList.add('fade-in');
        }

        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered', reg))
                    .catch(err => console.log('Service Worker registration failed', err));
            });
        }
    </script>
</body>
</html>
